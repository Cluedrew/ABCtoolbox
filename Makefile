# Make file for the ABC Tool Box:
# Not currantly working, WIP

# See DevManual.txt for details.

# The names of all of the tools.
TOOLLIST= hello-world

# Compiler Varaibles:
CXX=gcc
CXXFLAGS=-Wall -MMD -std=c++11

# Is it possible to link in libraries ahead of time,
# As well as join the partally made objects together?
LINK=ld
LINKFLAGS=-Ur

# Directory names:
# Intermediate objects    (hide later, maybe make it "tmp")
INTDIR=obj
# Completed objects       (hide later)
OBJDIR=obj
# Completed libraries
LIBDIR=include
# Code Directory
CODEDIR=code

# Special Rules:
.PHONY : all clean $(TOOLLIST)
.SECONDEXPANSION :

# Misc Varibles:
ALLCPP := $(wildcard $(CODEDIR)/*/*.cpp)
INTOBJ := $(patsubst $(CODEDIR)%.cpp,$(OBJDIR)%.o,$(ALLOBJ))
FINOBJ  = $(patsubst %,$(OBJDIR)/%.o,$(TOOLLIST))

# Functions:
# If given a turns the names of tools it is given to the names of the tools
# final files.
endfiles= $(foreach tool,$(1),$(LIBDIR)/$(tool).hpp $(LIBDIR)/lib$(tool).a)
toollib = $(LIBDIR)/lib$(1).a
toolhead= $(LIBDIR)/$(1).hpp
# Expands to the contents of the file $(1) if file exists.
# If the file does not exist expands to
safecat= $(shell [ -e $(1) ] && cat $(1))



### Rules:

# Default rule, updates all tools.
all : $(TOOLLIST)

# Tool level rule, create all final files for a tool.
$(TOOLLIST) : $(LIBDIR)/$$@.hpp $(LIBDIR)/lib$$@.a

# Create the static library in the include directory.
$(LIBDIR)/lib%.a : $(OBJDIR)/%.o | $(LIBDIR)
	ar rcs $@ $<

# Copy the public header over to the include directory.
$(LIBDIR)/%.hpp : $(CODEDIR)/%/%.hpp | $(LIBDIR)
	cp $< $@

# Rule for final objects
# (objects generated by linking and are used to create libraries)
$(FINOBJ) : $(OBJDIR)/%.o : $$(filter $(OBJDIR)/$$*/%.o,$(INTOBJ))
	$(LINK) $(LINKFLAGS) $^ $(call safecat, $(CODEDIR)/$*/libs) -o $@

# Rule for intermediate objects (or first stage objects)
$(INTOBJ) : $(OBJDIR)/%.o : $(CODEDIR)/%.cpp | $(OBJDIR)/$$(dir $$*)
	$(CXX) $(CXXFLAGS) -c $< -o $@

# Directory creation. Only INTDIR should ever have to be made.
$(INTDIR) $(OBJDIR) $(CODEDIR) $(LIBDIR) :
	mkdir $@
$(OBJDIR)/% : | $(OBJDIR)
	mkdir $@



# Add dependancy files.
-include $(dependancy)

# clean phony rule.
clean :
